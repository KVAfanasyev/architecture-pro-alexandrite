# Технический документ: Внедрение системы мониторинга в компании «Александрит»

---

## 1. Анализ системы и архитектуры

### 1.1. Обзор системы
Компания «Александрит» — ювелирная компания, предлагающая готовые и кастомизированные украшения через онлайн-платформу. Система состоит из:
- **Интернет-магазина** (Vue, TypeScript, Three.js) — для заказов и 3D-конструктора.
- **CRM** (Vue, SpringBoot) — для работы с клиентами и заказами.
- **MES** (C#, React) — для управления производством и расчёта стоимости.
- **Базы данных** (PostgreSQL) и **хранилища 3D-файлов** (S3).
- **Очереди сообщений** (RabbitMQ) — для асинхронного взаимодействия CRM и MES.

### 1.2. Ключевые компоненты для мониторинга:
- **API-сервисы** (Shop API, CRM API, MES API)
- **Базы данных** (Shop DB, MES DB)
- **Очередь RabbitMQ**
- **Хранилище S3**
- **Фронтенд-приложения** (SPA)

---

## 2. Мотивация внедрения мониторинга

### 2.1. Бизнес-ценность:
- **Снижение времени простоя** — система заказов напрямую влияет на выручку. Сбои в MES (расчёт стоимости) могут блокировать оформление заказов.
- **Улучшение пользовательского опыта** — медленная загрузка 3D-моделей или расчёт стоимости (2–30 мин) может привести к оттоку клиентов.
- **Оптимизация ресурсов** — мониторинг нагрузки на базы данных и API поможет планировать масштабирование.
- **Быстрое обнаружение инцидентов** — RabbitMQ и интеграции между системами являются точками отказа. Мониторинг очередей предотвратит потерю заказов.
- **Анализ производительности** — оценка времени расчёта стоимости в MES в зависимости от сложности модели.

### 2.2. Риски без мониторинга:
- Потеря заказов из-за незамеченных сбоев в очереди сообщений.
- Деградация производительности API, ведущая к отказам при пиковых нагрузках.
- Неконтролируемый рост хранилища S3 и баз данных.
- Ручное расследование инцидентов увеличивает время восстановления.

---

## 3. Выбор подхода к мониторингу

### 3.1. **RED-подход** (Rate, Errors, Duration)
- **Применяется к:** всем API-сервисам (Shop API, CRM API, MES API).
- **Причина:** подход ориентирован на мониторинг микросервисов и веб-сервисов, позволяет отслеживать доступность, ошибки и задержки.

### 3.2. **USE-подход** (Utilization, Saturation, Errors)
- **Применяется к:** инфраструктурным компонентам (базы данных, очереди RabbitMQ, серверы приложений).
- **Причина:** подход эффективен для мониторинга ресурсов (CPU, память, диски, сеть), помогает выявить узкие места.

### 3.3. **Четыре золотых сигнала** (Traffic, Errors, Latency, Saturation)
- **Применяется к:** комплексному мониторингу системы, особенно к интеграционным точкам (RabbitMQ, S3, MES).
- **Причина:** подход дополняет RED и USE, уделяя внимание насыщению и трафику, что критично для асинхронных систем.

---

## 4. Метрики для мониторинга

### 4.1. **API-сервисы** (RED + золотые сигналы)
| Метрика | Описание | Ярлыки (Labels) |
|---------|----------|-----------------|
| Number of requests (RPS) for internet shop API | Число запросов в секунду к Shop API | `service=shop-api`, `endpoint`, `method` |
| Number of HTTP 200 for shop API | Успешные ответы | `service=shop-api`, `status=200` |
| Number of HTTP 500 for shop API | Ошибки сервера | `service=shop-api`, `status=500` |
| Response time (latency) for shop API | Время ответа API | `service=shop-api`, `endpoint`, `percentile` |
| Number of simultaneous sessions for shop API | Число одновременных сессий | `service=shop-api` |
| Kb transferred (received/sent) for shop API | Объём переданных данных | `service=shop-api`, `direction` |

*Аналогично для CRM API и MES API.*

### 4.2. **Базы данных** (USE)
| Метрика | Описание | Ярлыки |
|---------|----------|--------|
| Memory Utilisation for shop db instance | Использование памяти БД | `db=shop-db` |
| Number of connections for shop db instance | Число подключений | `db=shop-db` |
| Size of shop db instance | Размер БД | `db=shop-db` |
| CPU % for shop API | Нагрузка CPU на сервере приложения | `service=shop-api` |

### 4.3. **RabbitMQ** (USE + золотые сигналы)
| Метрика | Описание | Ярлыки |
|---------|----------|--------|
| Number of dead-letter-exchange letters in RabbitMQ | Сообщения в dead-letter очереди | `queue`, `exchange` |
| Number of message in flight in RabbitMQ | Сообщения в обработке | `queue` |

### 4.4. **Хранилище S3**
| Метрика | Описание | Ярлыки |
|---------|----------|--------|
| Size of S3 storage | Размер хранилища 3D-файлов | `bucket=3d-files` |

### 4.5. **Дополнительные метрики** (предлагаются к добавлению):
| Метрика | Описание | Ярлыки |
|---------|----------|--------|
| MES price calculation time | Время расчёта стоимости в MES | `order_id`, `polygon_count` |
| 3D file upload success rate | Успешность загрузки 3D-файлов | `source=upload/constructor` |
| Order status transition latency | Время перехода статусов заказа | `from_status`, `to_status` |

---

## 5. Предлагаемый стек мониторинга

- **Сбор метрик:** Prometheus
- **Визуализация:** Grafana
- **Трассировка:** Jaeger (для отслеживания времени расчёта в MES)
- **Логи:** ELK-стек (Elasticsearch, Logstash, Kibana)
- **Оповещения:** Alertmanager

---

## 6. Рекомендации по внедрению


### 6.1. Подготовительный этап

#### 6.1.1. Инфраструктура мониторинга
- **Задача 1.1:** Создать namespace Kubernetes или выделенные виртуальные машины для стека мониторинга в каждом окружении (dev, release, prod)
- **Задача 1.2:** Развернуть кластер Prometheus с конфигурацией (3 инстанса) в prod-окружении
- **Задача 1.3:** Развернуть Grafana 
- **Задача 1.4:** Настроить Alertmanager с интеграцией Jira (автосоздание тикетов)
- **Задача 1.5:** Развернуть Jaeger для распределённой трассировки

#### 6.1.3. Интеграция с существующей инфраструктурой
- **Задача 1.6:** Настроить экспортеры метрик для:
    - PostgreSQL (postgres_exporter)
    - RabbitMQ (rabbitmq_exporter)
    - Node-exporter на всех EC2 инстансах
    - S3 метрики через CloudWatch exporter
- **Задача 1.7:** Инструментировать приложения:
    - Добавить Spring Boot Actuator + Micrometer в Shop API и CRM API
    - Добавить OpenTelemetry SDK в MES API (C#)
    - Настроить сбор фронтенд-метрик через RUM (Real User Monitoring)

### 6.2. Этап внедрения метрик

#### 6.2.1. Критические метрики (первый релиз)
- **Задача 2.1:** Настроить сбор RED-метрик для всех API:
    - Rate: RPS по каждому endpoint
    - Errors: HTTP 5xx, 4xx, таймауты
    - Duration: p50, p95, p99 latency
- **Задача 2.2:** Настроить мониторинг RabbitMQ:
    - Длина очереди
    - Dead letter сообщения
    - Скорость обработки
- **Задача 2.3:** Настроить USE-метрики для БД:
    - Connections
    - Query latency
    - Replication lag

#### 6.2.2. Бизнес-метрики (второй релиз)
- **Задача 2.4:** Реализовать кастомные метрики:
    - Время расчёта стоимости в MES (гистограмма по количеству полигонов)
    - Статусы заказов (граф переходов)
    - Конверсия: файл загружен → стоимость рассчитана
- **Задача 2.5:** Настроить дашборды для бизнес-аналитики:
    - Среднее время выполнения заказа
    - География заказов
    - Популярность конструктора vs загрузки файлов

### 6.3. Пороговые значения и показатели насыщенности

#### 6.3.1. API-сервисы
| Компонент | Показатель насыщенности | Пороговое значение | Обоснование |
|-----------|------------------------|-------------------|-------------|
| Shop API | Потребление CPU | 70% более 5 минут | Остаётся запас для пиковой нагрузки при распродажах |
| Shop API | Latency (p95) | > 2 секунды | UX-требование: пользователь не должен ждать дольше 2 сек |
| Shop API | Error rate | > 1% в течение 10 минут | Более 1% ошибок критично для конверсии |
| MES API | Время расчёта стоимости | > 45 минут | Техническое ограничение: пользователь может уйти с сайта |

#### 6.3.2. Базы данных
| Компонент | Показатель насыщенности | Пороговое значение | Обоснование |
|-----------|------------------------|-------------------|-------------|
| Shop DB | Active connections | > 80% от max_connections | Предотвращение исчерпания подключений |
| Shop DB | Query latency (p99) | > 500 мс | Влияет на общую производительность API |
| Shop DB | Disk space | > 85% | Необходим запас для WAL, бэкапов |
| MES DB | Размер БД | > 100 ГБ | Ограничение по стоимости managed-сервиса |

#### 6.3.3. RabbitMQ
| Показатель насыщенности | Пороговое значение | Обоснование |
|------------------------|-------------------|-------------|
| Длина очереди order_created | > 1000 сообщений | Более 1000 необработанных заказов приводит к задержкам производства |
| Сообщения в dead letter | > 10 сообщений | Указывает на проблемы с обработкой сообщений |
| Потребление памяти | > 80% | Риск падения очереди |

#### 6.3.4. Инфраструктура
| Компонент | Показатель насыщенности | Пороговое значение | Обоснование |
|-----------|------------------------|-------------------|-------------|
| EC2 инстансы | Память | > 85% | Необходим запас для GC, пиковой нагрузки |
| S3 хранилище | Размер | > 90% от квоты | Предотвращение отказа загрузки файлов |
| Сеть | Исходящий трафик | > 80% от лимита | Риск троттлинга со стороны облачного провайдера |

### 6.4. Процедуры реагирования на превышение порогов

#### 6.4.1. Уровень серьезности (Severity Levels)

##### **Severity 1 (Критический)**
- **Условия:** Одновременное превышение порогов по CPU (>90%) и Error rate (>5%) в Shop API
- **Действия:**
    1. Автоматическое создание инцидента в Jira с наивысшим приоритетом
    2. Нотификация всех инженеров и тимлида
    3. Автозапуск процедуры горизонтального масштабирования (добавление инстансов Shop API)
    4. Через 15 минут без реакции — автоматический звонок on-call инженеру через PagerDuty
    5. Если проблема не решена за 30 минут — эскалация на CTO

##### **Severity 2 (Высокий)**
- **Условия:** Длина очереди RabbitMQ > 1000 сообщений
- **Действия:**
    1. Автоматическое создание тикета в Jira
    2. Оповещение в Slack канал команды разработки
    3. Запуск автоматического анализа: проверка статуса MES API, доступность БД
    4. Если проблема не решена за 30 минут — добавление воркеров для обработки очереди

##### **Severity 3 (Средний)**
- **Условия:** Disk space БД > 85%
- **Действия:**
    1. Создание тикета в Jira
    2. Оповещение в Slack канал DevOps
    3. Автоматический запуск скрипта очистки временных данных
    4. Генерация отчёта для анализа роста данных

##### **Severity 4 (Низкий)**
- **Условия:** S3 storage > 90%
- **Действия:**
    1. Оповещение в Slack канал инфраструктуры
    2. Автоматическое увеличение квоты через API облачного провайдера
    3. Создание задачи на анализ использования хранилища

#### 6.4.2. Автоматические действия

##### **Масштабирование:**
```yaml
Автоскейлинг Shop API:
- триггер: CPU > 70% в течение 5 минут
- действие: +1 инстанс (макс. +3)
- колинг-период: 10 минут

Автоскейлинг MES API:
- триггер: очередь RabbitMQ > 500 сообщений
- действие: +1 воркер обработки
- макс. воркеров: количество ядер * 2
```

##### **Самоисцеление:**
- Перезапуск контейнера при OOM (Out Of Memory)
- Рестарт RabbitMQ при обнаружении утечек памяти
- Автоматический failover читающих реплик БД при высокой нагрузке

#### 6.4.3. Ручные процедуры

##### **Кризисные сценарии:**
1. **Полный отказ Shop API:**
    - Включение статической версии магазина (read-only)
    - Перенаправление трафика на CDN с кешированными страницами
    - Ручное создание заказов через CRM

2. **Отказ RabbitMQ:**
    - Переключение на fallback-режим: синхронные вызовы между CRM и MES
    - Восстановление из бекапа конфигурации RabbitMQ
