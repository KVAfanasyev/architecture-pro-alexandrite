# Анализ проблем и предлагаемые инициативы

## 1. Проблема: Медленная загрузка первой страницы MES (дашборд оператора)
**Описание**: Операторы жалуются на долгую загрузку первой страницы MES, где отображается список заказов в работе. Несмотря на введённую пагинацию и фильтры, проблема сохраняется. Для операторов критично видеть самые новые заказы, так как от этого зависит их оплата.

### 1.1. Приоритетная инициатива: Внедрение кэширования и оптимизация запросов к БД
**Описание**: Внедрить кэширование часто запрашиваемых данных (список новых заказов, агрегированные статусы) на уровне API MES. Использовать шаблон **Cache-Aside (Lazy Loading)**, так как он хорошо подходит для данных с частым чтением и относительно редким обновлением (статусы заказов меняются не каждую секунду). Кэшировать можно на 1-5 минут для баланса между актуальностью и производительностью. Дополнительно необходимо оптимизировать SQL-запросы (индексы по статусам и дате создания) и рассмотреть денормализацию данных для дашборда.

#### 1.1.1. Необходимость реализации в ближайшие полгода: **Высокая**
Проблема напрямую влияет на мотивацию и эффективность операторов, а также на скорость обработки заказов.

### 1.2. Инициатива: Вынос дашборда в отдельный сервис/микросервис
**Описание**: Создать отдельный lightweight-сервис (например, на Go или Node.js), который будет заниматься исключительно агрегацией данных для дашборда оператора. Он будет подписываться на события изменения статусов через RabbitMQ и поддерживать собственную оптимизированную БД (например, Elasticsearch или материализованное представление в PostgreSQL) для мгновенного отображения списков.

#### 1.2.1. Необходимость реализации в ближайшие полгода: **Средняя**
Это более фундаментальное изменение, требующее времени. Можно отложить, если оптимизация и кэширование дадут достаточный эффект.

## 2. Проблема: Медленный расчёт стоимости в MES
**Описание**: Расчёт стоимости может занимать до 30 минут для сложных моделей. Это создаёт задержки в процессе оформления заказа и негативный пользовательский опыт как в B2C, так и в B2B-сценариях.

### 2.1. Приоритетная инициатива: Асинхронная обработка и уведомления
**Описание**: Изменить API MES для немедленного принятия заказа и возврата его ID, а расчёт стоимости выполнять асинхронно. После завершения расчёта отправлять событие в RabbitMQ, на которое будут подписаны Shop API и CRM API для обновления статуса заказа и уведомления клиента.

#### 2.1.1. Необходимость реализации в ближайшие полгода: **Критическая**
Проблема является узким местом всей системы, особенно после открытия API и увеличения нагрузки. Без этого невозможна масштабируемость.

### 2.2. Инициатива: Масштабирование сервиса расчёта стоимости
**Описание**: Вынести логику расчёта стоимости в отдельный масштабируемый сервис (контейнер), который можно запускать в нескольких экземплярах и балансировать нагрузку. Использовать очередь (отдельный topic в RabbitMQ) для задач расчёта.

#### 2.2.1. Необходимость реализации в ближайшие полгода: **Высокая**
Прямо следует из первой инициативы. Необходимо для обработки пиковых нагрузок и обеспечения отказоустойчивости.

### 2.3. Инициатива: Оптимизация алгоритма расчёта
**Описание**: Проанализировать и оптимизировать алгоритм расчёта стоимости (возможно, его унаследовали из купленного MES). Рассмотреть возможность предварительного (pre-flight) расчёта для типовых конфигураций конструктора.

#### 2.3.1. Необходимость реализации в ближайшие полгода: **Средняя**
Может дать долгосрочный выигрыш, но требует глубокого анализа кода и, возможно, привлечения специалистов.

## 3. Проблема: Потеря заказов и несогласованность данных между системами
**Описание**: Клиенты не получают заказы, заказы "теряются" на несколько месяцев. Проблема усугубилась после открытия API и интеграции с внешними продавцами. Возможные причины: сбои в передаче сообщений между CRM и MES, отсутствие сквозного отслеживания (end-to-end traceability), ручные ошибки.

### 3.1. Приоритетная инициатива: Внедрение сквозного мониторинга и логирования (Distributed Tracing)
**Описание**: Внедрить инструмент Jaeger для отслеживания жизненного цикла заказа через все системы (Shop API -> CRM API -> MES API). Назначить заказу уникальный корреляционный ID на самом раннем этапе.

#### 3.1.1. Необходимость реализации в ближайшие полгода: **Критическая**
Без этого невозможно эффективно диагностировать, на каком этапе "теряются" заказы. Это основа для решения проблемы.

### 3.2. Инициатива: Повышение надёжности очереди сообщений (RabbitMQ)
**Описание**: Настроить подтверждение обработки сообщений (acknowledgments), устойчивые очереди (durable queues), механизмы повторной доставки (dead letter exchanges). Внедрить паттерн "Outbox" для гарантированной доставки событий из CRM и MES в очередь.

#### 3.2.1. Необходимость реализации в ближайшие полгода: **Высокая**
Повысит надёжность интеграции — основной артерии между критичными системами.

### 3.3. Инициатива: Создание единого дашборда статусов заказов для администраторов
**Описание**: Разработать отдельный внутренний инструмент (или расширить CRM), где продакт-менеджеры и менеджеры по продажам могли бы видеть статус любого заказа во всех системах, время пребывания в каждом статусе и быстро выявлять "зависшие" заказы.

#### 3.3.1. Необходимость реализации в ближайшие полгода: **Средняя**
Поможет оперативно реагировать на проблемы, но не устраняет коренные причины.

## 4. Проблема: Архитектурная связность и потенциальные узкие места
**Описание**: Текущая архитектура монолитна в рамках каждого контейнера (Shop API, CRM API, MES API). Базы данных имеют single point of failure. MES, являясь критичным ядром, одновременно занимается расчётом стоимости, управлением заданиями и предоставлением API для внешних партнёров.

### 4.1. Приоритетная инициатива: Рефакторинг MES API: разделение ответственности
**Описание**: Выделить из монолитного MES API отдельный сервис **Pricing Service** (расчёт стоимости) и **Order Fulfillment Service** (управление производственными заданиями). Оставить за текущим API MES роль шлюза (Gateway) для внешнего API и агрегатора для внутреннего SPA MES.

#### 4.1.1. Необходимость реализации в ближайшие полгода: **Высокая**
Позволит независимо масштабировать наиболее нагруженные части (расчёт стоимости) и упростит дальнейшую поддержку.

### 4.2. Инициатива: Повышение отказоустойчивости баз данных
**Описание**: Для DB_Shop и DB_MES перейти с single-инстанса на конфигурацию с репликацией (master-slave). Настроить подключение приложений к мастеру на запись и репликам на чтение (особенно для тяжёлых дашбордов).

#### 4.2.1. Необходимость реализации в ближайшие полгода: **Средняя/Высокая**
Снизит риски простоя и повысит производительность на чтение. Становится критичным по мере роста нагрузки.

### 4.3. Инициатива: Внедрение API Gateway
**Описание**: Поставить API Gateway (Kong, KrakenD) перед всеми внутренними API (Shop, CRM, MES Gateway). Это позволит централизованно управлять аутентификацией, авторизацией, лимитами запросов (rate limiting) для внешних партнёров, кэшированием ответов и маршрутизацией.

#### 4.3.1. Необходимость реализации в ближайшие полгода: **Средняя**
Особенно важно для контроля нагрузки от B2B-партнёров, но требует дополнительных ресурсов на внедрение и поддержку.

---

## Ответы на вопросы

### Если есть возможность выполнить только три пункта из списка инициатив в ближайшие полгода, что надо выбрать и почему?

1.  **Асинхронная обработка расчёта стоимости в MES (2.1)**.
    *   **Почему**: Это самое узкое и болезненное место системы, напрямую влияющее на пользовательский опыт (B2C и B2B) и пропускную способность всей компании. Без этого дальнейший рост невозможен.

2.  **Внедрение Distributed Tracing (3.1)**.
    *   **Почему**: Проблема "потерянных" заказов — самая критичная с бизнес-последствиями (потеря клиентов, репутации, денег). Невозможно решить проблему, которую нельзя измерить и локализовать. Tracing даст немедленную возможность диагностики.

3.  **Внедрение кэширования для дашборда MES (1.1)**.
    *   **Почему**: Проблема напрямую снижает эффективность производства (мотивация операторов) и уже озвучена командой. Решение относительно быстрое и даёт ощутимый эффект, повышая удовлетворённость внутренних пользователей и стабильность работы.

**Альтернативный выбор**: Если проблема "потерянных заказов" будет частично решена операционно (ручным отслеживанием), третьим пунктом можно взять **Разделение ответственности MES API (4.1)**, так как это закладывает архитектурный фундамент для будущего масштабирования и изоляции сбоев.

### Какой ты видишь целевую архитектуру через полгода?

Через полгода целевая архитектура должна эволюционировать в сторону **гибридной микросервисной архитектуры с чёткими bounded contexts**:

1.  **Фронтенды** остаются SPA (Vue/React), но общаются через единый **API Gateway**.
2.  **API Gateway** рулит внешним и внутренним трафиком, отвечает за аутентификацию, rate limiting для партнёров.
3.  **Ядро системы разделено на независимые сервисы**:
    *   **Order Service** (на базе Shop/CRM API): управление жизненным циклом заказа с точки зрения клиента и продавца. Главный источник истины о заказе. Публикует события в шину.
    *   **Pricing Service** (выделен из MES): асинхронный, масштабируемый сервис расчёта стоимости. Подписан на события "появилась 3D-модель".
    *   **Manufacturing Service** (на базе MES API): управление производственным конвейером, заданиями операторов. Получает заказы из шины после утверждения.
    *   **Notification Service**: отправка уведомлений (email, смс) клиентам и продавцам на основе событий из шины.
4.  **Событийная шина (RabbitMQ)** становится центральной нервной системой для асинхронной коммуникации между сервисами, обеспечивая слабую связность.
5.  **Базы данных**: У каждого сервиса своя БД (принцип Database per Service). Для отчётностей и дашбордов внедрён **отдельный read-optimized слой** (например, данные реплицируются в PostgreSQL для аналитики или Elasticsearch для поиска).
6.  **Операционная наблюдаемость**: Внедрены Distributed Tracing, централизованное логирование (ELK stack) и метрики (Prometheus/Grafana) для всех сервисов.
7.  **Инфраструктура**: Все сервисы контейнеризованы (Docker) и оркестрированы (Kubernetes или как минимум managed-сервис в Yandex Cloud), что позволяет быстро масштабировать уязвимые места (например, инстансы Pricing Service).

Эта архитектура позволит:
*   **Масштабироваться** частями, а не монолитом.
*   **Изолировать сбои** (падение Pricing Service не остановит приём заказов).
*   **Внедрять новые функции** (например, новые способы расчёта) быстрее и безопаснее.
*   **Чётко распределить ответственность** между командами (например, выделить команду на ядро Order Service, а другую — на производственные сервисы).