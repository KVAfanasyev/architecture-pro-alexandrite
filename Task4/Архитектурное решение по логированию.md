# Анализ системы и планирование логирования для компании «Александрит»

## Мотивация внедрения логирования

**Технические преимущества:**
1. **Ускорение расследования инцидентов** — централизованные логи позволят быстро находить корневые причины проблем с заказами
2. **Мониторинг производительности** — выявление узких мест в системе (например, медленная загрузка MES)
3. **Трассировка полного цикла заказа** — отслеживание заказа от создания до доставки через все системы

**Бизнес-метрики, которые улучшит логирование:**
1. **Сокращение времени обработки заказа** — выявление задержек между статусами
2. **Увеличение удовлетворенности клиентов** — быстрое реагирование на жалобы
3. **Снижение потери заказов** — обнаружение "потерянных" заказов в системе
4. **Оптимизация нагрузки на операторов** — анализ распределения заказов
5. **Улучшение SLA для API-партнеров** — мониторинг доступности и производительности API

## Предлагаемое решение

### Технологический стек:
- **Centralized Logging System**: ELK Stack (Elasticsearch, Logstash, Kibana)
- **Log Collection**: Fluentd/Fluent Bit для сбора логов с контейнеров
- **Log Storage**: Elasticsearch
- **Security**: Elasticsearch Security с RBAC


### Единая структура логов (JSON):
```json
{
  "timestamp": "2024-01-15T10:30:00Z",
  "system": "MES",
  "service": "api_mes",
  "level": "INFO",
  "correlation_id": "uuid-v4",
  "order_id": "ORD-123456",
  "customer_id": "CUST-789",
  "user_id": "USER-456",
  "action": "status_change",
  "status_from": "MANUFACTURING_STARTED",
  "status_to": "MANUFACTURING_COMPLETED",
  "duration_ms": 1500,
  "resource": "/api/orders/123456/status",
  "metadata": {
    "operator_id": "OP-001",
    "manufacturing_time_minutes": 120
  }
}
```

## Список необходимых логов (уровень INFO)

### Для всех систем:
1. **Изменение статуса заказа** — ключевое событие
    - Поля: timestamp, system, order_id, customer_id, status_from, status_to, user_id

2. **Вход/выход пользователя** — аудит доступа
    - Поля: timestamp, system, user_id, role, action

3. **API-вызовы** — все входящие и исходящие запросы
    - Поля: timestamp, system, endpoint, method, status_code, duration_ms, correlation_id

### Специфичные логи:

#### Shop API:
4. **Загрузка 3D-файла** — file_uploaded
    - Поля: timestamp, order_id, customer_id, file_size_mb, polygon_count, upload_duration_ms

5. **Расчет стоимости** — price_calculation_requested
    - Поля: timestamp, order_id, calculation_id, polygon_count, estimated_duration_sec

#### MES API:
6. **Назначение оператора** — operator_assigned
    - Поля: timestamp, order_id, operator_id, assigned_by, queue_position

7. **Начало/окончание производства** — manufacturing_{started|completed}
    - Поля: timestamp, order_id, operator_id, machine_id, actual_duration_min

#### CRM:
8. **Подтверждение заказа** — order_confirmed
    - Поля: timestamp, order_id, confirmed_by, confirmation_source

#### Message Queue:
9. **Отправка/получение сообщения** — message_{published|consumed}
    - Поля: timestamp, queue_name, message_type, message_id, order_id, processing_time_ms

## Уровни логирования и их использование

- **ERROR**: Неустранимые ошибки, требующие немедленного вмешательства
    - Потеря заказа, сбой расчета стоимости, недоступность БД
- **WARN**: Потенциальные проблемы, требующие мониторинга
    - Медленные запросы (>5 сек), повторные попытки, почти заполненная очередь
- **INFO**: Бизнес-события и нормальная работа (перечислены выше)
- **DEBUG**: Детальная отладка, включать только при расследовании инцидентов

## Приоритет настройки логирования

1. **MES API и MES Frontend** — самые проблемные зоны (медленная загрузка, потеря заказов)
2. **Message Queue** — критичная интеграция между системами
3. **Shop API** — точка входа заказов от клиентов
4. **CRM** — управление клиентскими отношениями

## Политика безопасности

### Чувствительные данные:
- **Маскировка**: Номера карт, паспортные данные, email (частично)
- **Исключение**: Пароли никогда не логируются
- **Шифрование**: Логи в хранилище зашифрованы (AES-256)

### Доступ:
- **Level 1 (Операторы)**: Только логи своих операций
- **Level 2 (Support Team)**: Все логи, кроме персональных данных
- **Level 3 (Администраторы)**: Полный доступ с аудитом действий
- **Ротация паролей**: Каждые 90 дней для доступа к Kibana

## Политика хранения логов

| Тип логов | Хранение | Индекс | Примерный объем/день |
|-----------|----------|---------|---------------------|
| ERROR/WARN | 90 дней | logs-error-* | 2 GB |
| INFO (бизнес-события) | 30 дней | logs-info-* | 10 GB |
| DEBUG | 7 дней | logs-debug-* | 15 GB |
| Аудиторские | 1 год | logs-audit-* | 1 GB |

**Общий объем**: ~28 GB/день, ~840 GB/месяц
**Стратегия**: Горячее хранение (7 дней), теплое (30 дней), холодное (90+ дней)

## Система анализа логов

### Алертинг:
1. **Задержка в статусах**: Если заказ в статусе PRICE_CALCULATED > 1 часа
2. **Ошибки расчета**: >5% ошибок расчета стоимости за 5 минут
3. **Медленные ответы**: API response time > 10 секунд
4. **Аномальная нагрузка**: Увеличение запросов > 300% за 1 минуту
5. **Потеря сообщений**: >10 сообщений не обработаны за 15 минут

### Поиск аномалий:
- ML-алгоритмы для обнаружения необычных паттернов
- Автоматическое обнаружение DDoS (резкий рост запросов)
- Выявление "зависших" заказов (статус не меняется > 24 часа)

## Критерии выбора технологии

| Критерий | ELK Stack | Loki | Splunk | Выбор |
|----------|-----------|------|--------|-------|
| Лицензия | Elastic License | Apache 2.0 | Проприетарная | ELK |
| Стоимость | Бесплатно (базовый) | Бесплатно | Дорого | ELK |
| Производительность | Высокая | Средняя | Высокая | ELK |
| Поддержка JSON | Отличная | Хорошая | Отличная | ELK |
| Интеграция с OpenTelemetry | Хорошая | Средняя | Хорошая | ELK |
| Кривые обучения | Средняя | Низкая | Высокая | ELK |
| Сообщество | Огромное | Растущее | Большое | ELK |

**Выбор**: ELK Stack — оптимальное соотношение функциональности, стоимости и сообщества

---

